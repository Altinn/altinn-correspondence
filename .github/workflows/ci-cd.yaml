name: CI/CD

on:
  push:
    branches: [ main ]
    paths-ignore:
    - "Test/**" # ignore changes to tests

jobs:

  test:	
    name: QA	
    uses: ./.github/workflows/test-application.yml	

  build:
    name: Build and Publish Artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Application
        run: dotnet build

      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
          name: correspondence-artifact
          path: ./build

  deploy-test:
    name: Internal test
    needs: build
    uses: ./.github/workflows/deploy-to-environment.yml
    if: always() && !failure() && !cancelled() 
    permissions: 
      id-token: write
      contents: read
      packages: write
    secrets: inherit
    with:
      environment: test

  deploy-staging:
    name: Internal staging
    uses: ./.github/workflows/deploy-to-environment.yml
    if: always() && !failure() && !cancelled() 
    needs: [ 
      deploy-test
    ]
    permissions: 
      id-token: write
      contents: read
      packages: write
    secrets: inherit
    with:
      environment: staging

  deploy-production:
    name: Production
    needs: [
      deploy-staging,
    ]
    uses: ./.github/workflows/deploy-to-environment.yml
    if: (!failure() && !cancelled())
    permissions: 
      id-token: write
      contents: read
      packages: write
    secrets: inherit
    with:
      environment: production

  release-to-git:  
    name: Release to git
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: ${{ !failure() && !cancelled()}}
    permissions: 
      id-token: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Release
        if: (!failure() && !cancelled())
        uses: ./.github/actions/release-to-git
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
