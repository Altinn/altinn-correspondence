using Altinn.Broker.Application;
using Altinn.Correspondence.Application;
using Altinn.Correspondence.Application.MalwareScanResultCommand.Models;
using Azure.Messaging.EventGrid;
using Azure.Messaging.EventGrid.SystemEvents;
using Microsoft.AspNetCore.Mvc;
using System.Text.Json;

namespace Altinn.Correspondence.API.Controllers
{
    [ApiController]
    [Route("correspondence/api/v1/webhooks/malwarescanresults")]
    public class MalwareScanResultsController(/*IIdempotencyEventRepository idempotencyEventRepository, */ILogger<MalwareScanResultsController> logger) : Controller
    {
        //private readonly IIdempotencyEventRepository _idempotencyEventRepository;
        private readonly ILogger<MalwareScanResultsController> _logger = logger;
        private const string malwareScanEventType = "Microsoft.Security.MalwareScanningResult";

        [HttpPost]
        [Consumes("application/json")]
        public async Task<ActionResult> ProcessMalwareScanResult([FromBody] EventGridEvent eventGridEvent, [FromServices] MalwareScanResultCommandHandler handler, CancellationToken cancellationToken)
        {
            _logger.LogInformation("Got malware scan event of type {EventType} with data: {eventData}", eventGridEvent.EventType, eventGridEvent.Data.ToString());
            if (eventGridEvent.TryGetSystemEventData(out object eventData)
                && eventData is SubscriptionValidationEventData subscriptionValidationEventData)
            {
                return new OkObjectResult(new
                {
                    ValidationResponse = subscriptionValidationEventData.ValidationCode
                });
            }
            else if (eventGridEvent.EventType == malwareScanEventType)
            {
                _logger.LogInformation("Got malware scan result data: {MalwareScanResultData}",eventGridEvent.Data.ToString());
                ScanResultData? result = JsonSerializer.Deserialize<ScanResultData>(eventGridEvent.Data.ToString());
                if (result is null)
                {
                    _logger.LogError("Failed to deserialize malware scan result data");
                    return BadRequest();
                }
                //var processFunction = new Func<Task<OneOf<Task, Error>>>(() => handler.Process(result, cancellationToken));
                //var commandResult = await IdempotencyEventHelper.ProcessEvent(result.ETag, processFunction, _idempotencyEventRepository, cancellationToken);
                var commandResult = await handler.Process(result, cancellationToken);
                return commandResult.Match(
                    Ok,
                    Problem
                );
            }
            else
            {
                _logger.LogError("Got unknown event: {EventData}", eventData.ToString());
                return BadRequest();
            }
        }
        private ObjectResult Problem(Error error) => Problem(detail: error.Message, statusCode: (int)error.StatusCode);
    }
}
